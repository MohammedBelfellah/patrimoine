{% extends "core/base.html" %}
{% block title %}Gestion des utilisateurs{% endblock %}
{% block content %}
<div class="card">
    <h2>üë• Gestion des utilisateurs</h2>
    <p class="muted">Assignez les r√¥les (ADMIN, INSPECTEUR) aux utilisateurs.</p>

    <div style="margin: 16px 0; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px;">
        <h3 style="margin-top: 0;">‚ûï Ajouter un utilisateur</h3>
        {% if error %}
        <div style="color: #dc2626; padding: 10px; background: #fee2e2; border-radius: 4px; margin-bottom: 12px;">
            ‚ùå {{ error }}
        </div>
        {% endif %}
        {% if success %}
        <div style="color: #065f46; padding: 10px; background: #d1fae5; border-radius: 4px; margin-bottom: 12px;">
            ‚úÖ {{ success }}
        </div>
        {% endif %}
        <form method="post" action="{% url 'user-management' %}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            {% csrf_token %}
            <div style="display: flex; flex-direction: column;">
                <label for="email" style="font-weight: bold; margin-bottom: 4px;">Email *</label>
                <input type="email" id="email" name="email" required />
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="username" style="font-weight: bold; margin-bottom: 4px;">Nom d'utilisateur *</label>
                <input type="text" id="username" name="username" required />
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="password" style="font-weight: bold; margin-bottom: 4px;">Mot de passe *</label>
                <input type="password" id="password" name="password" required />
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="role" style="font-weight: bold; margin-bottom: 4px;">R√¥le *</label>
                <select id="role" name="role" required>
                    <option value="ADMIN">ADMIN</option>
                    <option value="INSPECTEUR">INSPECTEUR</option>
                    <option value="PUBLIC" selected>PUBLIC</option>
                </select>
            </div>
            <div style="display: flex; align-items: end;">
                <button type="submit" style="padding: 10px 16px; background: #1d4ed8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;">Cr√©er</button>
            </div>
        </form>
    </div>

    {% if users %}
    <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
        <thead>
            <tr style="background: #f0f0f0;">
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Email</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Groupes</th>
                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px;">
                    <strong>{{ user.email }}</strong>
                    {% if user.is_superuser %}
                    <br><span style="color: #d97706; font-size: 0.85em;">‚≠ê Superadmin</span>
                    {% endif %}
                </td>
                <td style="padding: 10px;">
                    {% if user.group_names %}
                    {% for group in user.group_names %}<span
                        style="background: #dbeafe; padding: 4px 8px; border-radius: 4px; margin-right: 4px;">{{ group
                        }}</span>{% endfor %}
                    {% else %}
                    <span class="muted">Aucun r√¥le</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; text-align: center;">
                    <form method="post" action="{% url 'toggle-user-group' user_id=user.id group_name='ADMIN' %}"
                        style="display: inline-block; margin-right: 8px;">
                        {% csrf_token %}
                        <button type="submit"
                            style="padding: 6px 12px; background: {% if user.is_admin %}#ef4444{% else %}#10b981{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                            {% if user.is_admin %}Retirer ADMIN{% else %}Ajouter ADMIN{% endif %}
                        </button>
                    </form>
                    <form method="post" action="{% url 'toggle-user-group' user_id=user.id group_name='INSPECTEUR' %}"
                        style="display: inline-block;">
                        {% csrf_token %}
                        <button type="submit"
                            style="padding: 6px 12px; background: {% if user.is_inspecteur %}#ef4444{% else %}#10b981{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                            {% if user.is_inspecteur %}Retirer INSPECTEUR{% else %}Ajouter INSPECTEUR{% endif %}
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">Aucun utilisateur trouv√©.</p>
    {% endif %}
</div>
{% endblock %}