{% extends "core/base.html" %}
{% block title %}Inspection - {{ inspection.id_patrimoine.nom_fr }}{% endblock %}
{% block content %}

<div class="card">
  <h2><i class="bi bi-clipboard-check"></i> Inspection: {{ inspection.id_patrimoine.nom_fr }}</h2>
  <p class="muted"><small>{{ inspection.id_patrimoine.full_location }}</small></p>

  {% if documents %}
  <div style="margin-bottom: 18px;">
    <h4 style="margin-bottom: 8px;"><i class="bi bi-file-earmark-pdf"></i> Documents liés à cette inspection</h4>
    <ul style="list-style: none; padding-left: 0;">
      {% for doc in documents %}
      <li style="margin-bottom: 8px;">
        <span style="margin-right: 8px;">
          {% if doc.type_document == "PDF" %}
            <i class="bi bi-file-earmark-pdf"></i>
          {% else %}
            <i class="bi bi-file-earmark"></i>
          {% endif %}
        </span>
        {{ doc.file_name }}
        <span style="color: #6b7280; font-size: 0.95rem;">({{ doc.type_document }}, {{ doc.file_size_mb }} MB)</span>
        <a href="/media/{{ doc.file_path }}" target="_blank" class="btn btn-sm btn-primary" style="margin-left: 12px;">
          <i class="bi bi-eye"></i> Ouvrir
        </a>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
      <div>
        <strong>Date d'inspection:</strong>
        <p>{{ inspection.date_inspection|date:"d/m/Y" }}</p>
      </div>
      <div>
        <strong>État:</strong>
        <p>
          {% if inspection.etat == 'BON' %}
          <span style="padding: 4px 12px; background: #d1fae5; border-radius: 4px; font-weight: bold;">{{ inspection.get_etat_display }}</span>
          {% elif inspection.etat == 'MOYEN' %}
          <span style="padding: 4px 12px; background: #fef3c7; border-radius: 4px; font-weight: bold;">{{ inspection.get_etat_display }}</span>
          {% else %}
          <span style="padding: 4px 12px; background: #fee2e2; border-radius: 4px; font-weight: bold;">{{ inspection.get_etat_display }}</span>
          {% endif %}
        </p>
      </div>
      <div>
        <strong>Inspecteur:</strong>
        <p>{{ inspection.id_inspecteur.email }}</p>
      </div>
      <div>
        <strong>Dernière mise à jour:</strong>
        <p>{{ inspection.updated_at|date:"d/m/Y H:i" }}</p>
      </div>
    </div>

    {% if inspection.observations %}
    <div style="margin-top: 12px;">
      <strong>Observations:</strong>
      <p style="margin-top: 4px;">{{ inspection.observations }}</p>
    </div>
    {% endif %}
  </div>

  <div style="margin-bottom: 16px; display: flex; gap: 10px;">
    {% if can_request_modification %}
    <a href="{% url 'inspection-request-edit' inspection.id_inspection %}" class="btn btn-warning"><i
        class="bi bi-pencil-square"></i> Demander une modification</a>
    {% endif %}
    <a href="{% url 'inspection-list' %}" class="btn btn-secondary">Retour</a>
  </div>

  <!-- Documents Section -->
  {% if documents %}
  <div style="margin-top: 24px;">
    <h3><i class="bi bi-file-earmark-pdf"></i> Documents et PDF liés à cette inspection</h3>
    <ul style="list-style: none; padding-left: 0;">
      {% for doc in documents %}
      <li style="margin-bottom: 10px;">
        {% if doc.type_document == "PDF" %}
          <a href="/media/{{ doc.file_path }}" target="_blank" style="color: #dc2626; font-weight: bold;">
            <i class="bi bi-file-earmark-pdf"></i> {{ doc.file_name }}
          </a>
        {% else %}
          <a href="/media/{{ doc.file_path }}" target="_blank">
            <i class="bi bi-file-earmark"></i> {{ doc.file_name }}
          </a>
        {% endif %}
        <span style="color: #6b7280; font-size: 0.95rem;">({{ doc.type_document }}, {{ doc.file_size_mb }} MB)</span>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Modification Requests Section -->
  {% if modification_requests %}
  <div style="margin-top: 24px;">
    <h3>Historique des demandes de modification</h3>
    <style>
      .modification-item {
        border-left: 4px solid;
        border-radius: 6px;
        margin-bottom: 12px;
      }

      .modification-header {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }

      .modification-header:hover {
        opacity: 0.85;
      }

      .modification-header-info {
        font-weight: 600;
        font-size: 0.95rem;
      }

      .modification-content {
        padding: 0 16px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .modification-content.show {
        max-height: 600px;
        padding: 12px 16px;
      }
    </style>

    {% for req in modification_requests %}
    <div class="modification-item"
      style="background: {% if req.status == 'PENDING' %}#fef9c3{% elif req.status == 'APPROVED' %}#d1fae5{% else %}#fee2e2{% endif %}; border-left-color: {% if req.status == 'PENDING' %}#ca8a04{% elif req.status == 'APPROVED' %}#059669{% else %}#dc2626{% endif %};">

      <!-- Collapsible Header -->
      <div class="modification-header"
        onclick="this.nextElementSibling.classList.toggle('show'); this.querySelector('.toggle-icon').textContent = this.nextElementSibling.classList.contains('show') ? '▼' : '▶';">
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <span class="toggle-icon" style="color: #666; font-size: 0.8rem;">▶</span>
          <div>
            <div class="modification-header-info"
              style="color: {% if req.status == 'PENDING' %}#854d0e{% elif req.status == 'APPROVED' %}#065f46{% else %}#991b1b{% endif %};">
              {% if req.status == 'PENDING' %}<i class="bi bi-hourglass-split"></i>{% elif req.status == 'APPROVED' %}<i
                class="bi bi-check-circle-fill"></i>{% else %}<i class="bi bi-x-circle-fill"></i>{% endif %}
              {{ req.get_status_display }}
            </div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">
              Demandée le {{ req.requested_at|date:"d/m/Y H:i" }} par {{ req.requested_by.email }}
            </div>
          </div>
        </div>
        <span style="color: #999; font-size: 0.9rem;">{{ req.proposed_data.etat }}</span>
      </div>

      <!-- Expandable Content -->
      <div class="modification-content">
        <!-- Proposed Changes -->
        <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
          <strong style="color: #1f2937; font-size: 0.95rem; display: block; margin-bottom: 8px;">Changements
            proposés:</strong>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.9rem;">
            <div>
              <strong style="color: #4b5563;">Date:</strong>
              <p style="margin: 4px 0; color: #1f2937;">{{ req.proposed_data.date_inspection }}</p>
            </div>
            <div>
              <strong style="color: #4b5563;">État:</strong>
              <p style="margin: 4px 0; color: #1f2937;">{{ req.proposed_data.etat }}</p>
            </div>
            {% if req.proposed_data.observations %}
            <div>
              <strong style="color: #4b5563;">Observations:</strong>
              <p style="margin: 4px 0; color: #1f2937;">{{ req.proposed_data.observations }}</p>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Admin Actions (Approval/Rejection) -->
        {% if req.status == 'PENDING' and is_admin %}
        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px;">

          <!-- Approve Form -->
          <form method="post" action="{% url 'inspection-request-approve' req.id_request %}"
            style="display: flex; flex-direction: column; gap: 6px;">
            {% csrf_token %}
            <label style="font-size: 0.85rem; font-weight: 600; color: #1f2937;">Note (optionnel):</label>
            <input type="text" name="admin_note" placeholder="Note..."
              style="padding: 6px 8px; border: 1px solid #d8dee6; border-radius: 4px; font-size: 0.85rem;">
            <button type="submit"
              style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem;"
              onclick="return confirm('Approuver?');"><i class="bi bi-check-circle"></i> Approuver</button>
          </form>

          <!-- Reject Form -->
          <form method="post" action="{% url 'inspection-request-reject' req.id_request %}"
            style="display: flex; flex-direction: column; gap: 6px;">
            {% csrf_token %}
            <label style="font-size: 0.85rem; font-weight: 600; color: #1f2937;">Raison:</label>
            <input type="text" name="admin_note" placeholder="Raison..."
              style="padding: 6px 8px; border: 1px solid #d8dee6; border-radius: 4px; font-size: 0.85rem;">
            <button type="submit"
              style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem;"
              onclick="return confirm('Rejeter?');"><i class="bi bi-trash"></i> Rejeter</button>
          </form>
        </div>
        {% endif %}

        <!-- Review Info (if already reviewed) -->
        {% if req.reviewed_by %}
        <div style="background: white; padding: 12px; border-radius: 4px; border-left: 2px solid #d8dee6; font-size: 0.9rem;">
          <strong style="color: #4b5563;">Examiné par {{ req.reviewed_by.email }} le {{ req.reviewed_at|date:"d/m/Y H:i" }}</strong>
          {% if req.admin_note %}
          <p style="margin-top: 6px; color: #666;">{{ req.admin_note }}</p>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<style>
  .btn {
    display: inline-block;
    padding: 8px 16px;
    text-decoration: none;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    color: white;
  }

  .btn-warning {
    background: #f59e0b;
  }

  .btn-success {
    background: #10b981;
  }

  .btn-danger {
    background: #ef4444;
  }

  .btn-secondary {
    background: #6b7280;
  }

  .btn:hover {
    opacity: 0.9;
  }
</style>
{% endblock %}