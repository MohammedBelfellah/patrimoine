{% extends "core/base.html" %}
{% block title %}Ajouter inspection{% endblock %}
{% block head_extra %}
<style>
  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  label {
    font-weight: bold;
    margin-bottom: 4px;
  }

  input,
  select,
  textarea {
    padding: 8px;
    width: 100%;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }

  textarea {
    min-height: 100px;
  }

  button {
    padding: 10px 16px;
    background: #1d4ed8;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  button:hover {
    background: #1e40af;
  }

  .error {
    color: #dc2626;
    padding: 12px;
    background: #fee2e2;
    border-radius: 4px;
    margin-bottom: 16px;
  }

  .info {
    background: #dbeafe;
    border-left: 4px solid #1d4ed8;
    padding: 12px;
    margin-bottom: 16px;
  }
</style>
{% endblock %}
{% block content %}
<div class="card">
  <h2>Ajouter une inspection</h2>

  <div class="info">
    <strong><i class="bi bi-info-circle"></i> R√©serv√© aux Inspecteurs:</strong> Seuls les utilisateurs avec le r√¥le
    "Inspecteur" peuvent cr√©er des inspections. Les administrateurs peuvent uniquement consulter et approuver les
    demandes de modification.
  </div>

  {% if error %}
  <div class="error"><i class="bi bi-x-circle"></i> {{ error }}</div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

  <!-- ...existing form fields... -->

    <div class="form-group">
      <label for="id_region"><strong>R√©gion *</strong></label>
      <select id="id_region" name="id_region" required onchange="updateInspectionProvinces()">
        <option value="">-- S√©lectionner --</option>
        {% for region in regions %}
        <option value="{{ region.id_region }}">{{ region.nom_region }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="id_province"><strong>Province/Pr√©fecture *</strong></label>
      <select id="id_province" name="id_province" required onchange="updateInspectionCommunes()">
        <option value="">-- S√©lectionner --</option>
      </select>
    </div>

    <div class="form-group">
      <label for="id_commune"><strong>Commune *</strong></label>
      <select id="id_commune" name="id_commune" required onchange="updateInspectionPatrimoines()">
        <option value="">-- S√©lectionner --</option>
      </select>
    </div>

    <div class="form-group">
      <label for="id_patrimoine"><strong>Patrimoine *</strong></label>
      <select id="id_patrimoine" name="id_patrimoine" required>
        <option value="">-- S√©lectionner --</option>
        {% for p in patrimoines %}
        <option value="{{ p.id_patrimoine }}">{{ p.nom_fr }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="date_inspection"><strong>Date d'inspection *</strong></label>
      <input type="date" id="date_inspection" name="date_inspection" required />
    </div>

    <div class="form-group">
      <label for="etat"><strong>√âtat *</strong></label>
      <select id="etat" name="etat" required>
        <option value="">-- S√©lectionner --</option>
        {% for code, label in inspection_etat %}
        <option value="{{ code }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="observations"><strong>Observations</strong></label>
      <textarea id="observations" name="observations"></textarea>
    </div>

    <!-- File upload field moved to the end -->
    <div class="form-group">
      <label for="files"><strong>Fichiers (PDF, Word, images, max 5)</strong></label>
      <input type="file" id="files" name="files" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp" multiple />
      <p class="muted" style="margin-top: 4px;"><small>Formats accept√©s: PDF, DOC, DOCX, JPG, PNG, GIF, WEBP. Maximum 5 fichiers.</small></p>
      <div id="file-preview" style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;"></div>
    </div>

    <div style="display: flex; gap: 10px;">
      <button type="submit" style="flex: 1;">Cr√©er inspection</button>
      <a href="{% url 'inspection-list' %}" class="btn btn-secondary"
        style="padding: 10px 16px; text-decoration: none; background: #6b7280; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex: 1;">Annuler</a>
    </div>

    <!-- File upload preview script will be moved below -->
  </form>
</div>

<!-- Move all scripts to the end for global scope -->
  </div>

  <script>
  // File upload preview
  document.getElementById('files').addEventListener('change', function (e) {
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';
    const files = Array.from(e.target.files);
    if (files.length > 5) {
      alert('Maximum 5 fichiers autoris√©s');
      e.target.value = '';
      return;
    }
    files.forEach(file => {
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'center';
      div.style.maxWidth = '100px';
      div.style.fontSize = '12px';
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.width = '80px';
          img.style.height = '80px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '2px solid #e5e7eb';
          img.title = file.name;
          div.appendChild(img);
          const label = document.createElement('div');
          label.textContent = file.name;
          div.appendChild(label);
        };
        reader.readAsDataURL(file);
      } else {
        const icon = document.createElement('span');
        icon.textContent = 'üìÑ';
        icon.style.fontSize = '2em';
        div.appendChild(icon);
        const label = document.createElement('div');
        label.textContent = file.name;
        div.appendChild(label);
      }
      preview.appendChild(div);
    });
  });

  // Dynamic selects
  function updateInspectionProvinces() {
    console.log('updateInspectionProvinces called');
    const regionId = document.getElementById('id_region').value;
    const provinceSelect = document.getElementById('id_province');
    const communeSelect = document.getElementById('id_commune');
    const patrimoineSelect = document.getElementById('id_patrimoine');

    communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

    if (!regionId) {
      provinceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }

    provinceSelect.innerHTML = '<option value="">Chargement...</option>';
    fetch(`/api/provinces/${regionId}/`)
      .then(r => {
        if (!r.ok) {
          alert('Erreur AJAX: provinces');
          console.error('AJAX error provinces:', r.status, r.statusText);
          provinceSelect.innerHTML = '<option value="">Erreur chargement</option>';
          return [];
        }
        return r.json();
      })
      .then(data => {
        console.log('Provinces response:', data);
        if (!Array.isArray(data) || data.length === 0) {
          provinceSelect.innerHTML = '<option value="">Aucune province trouv√©e</option>';
          return;
        }
        provinceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_province;
          opt.textContent = p.nom_province;
          provinceSelect.appendChild(opt);
        });
      })
      .catch(err => {
        alert('Erreur JS provinces: ' + err);
        provinceSelect.innerHTML = '<option value="">Erreur JS</option>';
        console.error('Error loading provinces:', err);
      });
  }

  function updateInspectionCommunes() {
    const provinceId = document.getElementById('id_province').value;
    const communeSelect = document.getElementById('id_commune');
    const patrimoineSelect = document.getElementById('id_patrimoine');

    patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

    if (!provinceId) {
      communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }

    fetch(`/api/communes/${provinceId}/`)
      .then(r => {
        if (!r.ok) {
          alert('Erreur AJAX: communes');
          console.error('AJAX error communes:', r.status, r.statusText);
        }
        return r.json();
      })
      .then(data => {
        console.log('Communes response:', data);
        communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id_commune;
          opt.textContent = c.nom_commune;
          communeSelect.appendChild(opt);
        });
      })
      .catch(err => {
        alert('Erreur JS communes');
        console.error('Error loading communes:', err);
      });
  }

  function updateInspectionPatrimoines() {
    const communeId = document.getElementById('id_commune').value;
    const patrimoineSelect = document.getElementById('id_patrimoine');

    if (!communeId) {
      patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }

    fetch(`/api/patrimoines-by-commune/${communeId}/`)
      .then(r => {
        if (!r.ok) {
          alert('Erreur AJAX: patrimoines');
          console.error('AJAX error patrimoines:', r.status, r.statusText);
        }
        return r.json();
      })
      .then(data => {
        console.log('Patrimoines response:', data);
        patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_patrimoine;
          opt.textContent = p.nom_fr;
          patrimoineSelect.appendChild(opt);
        });
      })
      .catch(err => {
        alert('Erreur JS patrimoines');
        console.error('Error loading patrimoines:', err);
      });
  }
  </script>
<script>
  // Get list of regions
  const regionApi = '/api/regions/';

  function updateInspectionProvinces() {
    console.log('updateInspectionProvinces called');
    const regionId = document.getElementById('id_region').value;
    const provinceSelect = document.getElementById('id_province');
    const communeSelect = document.getElementById('id_commune');
    const patrimoineSelect = document.getElementById('id_patrimoine');

    communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

    if (!regionId) {
      provinceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }

    provinceSelect.innerHTML = '<option value="">Chargement...</option>';
    fetch(`/api/provinces/${regionId}/`)
      .then(r => {
        if (!r.ok) {
          alert('Erreur AJAX: provinces');
          console.error('AJAX error provinces:', r.status, r.statusText);
          provinceSelect.innerHTML = '<option value="">Erreur chargement</option>';
          return [];
        }
        return r.json();
      })
      .then(data => {
        console.log('Provinces response:', data);
        if (!Array.isArray(data) || data.length === 0) {
          provinceSelect.innerHTML = '<option value="">Aucune province trouv√©e</option>';
          return;
        }
        provinceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_province;
          opt.textContent = p.nom_province;
          provinceSelect.appendChild(opt);
        });
      })
      .catch(err => {
        alert('Erreur JS provinces: ' + err);
        provinceSelect.innerHTML = '<option value="">Erreur JS</option>';
        console.error('Error loading provinces:', err);
      });
  }

  function updateInspectionCommunes() {
    const provinceId = document.getElementById('id_province').value;
    const communeSelect = document.getElementById('id_commune');
    const patrimoineSelect = document.getElementById('id_patrimoine');

    patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

    if (!provinceId) {
      communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }

    fetch(`/api/communes/${provinceId}/`)
      .then(r => {
        if (!r.ok) {
          alert('Erreur AJAX: communes');
          console.error('AJAX error communes:', r.status, r.statusText);
        }
        return r.json();
      })
      .then(data => {
        console.log('Communes response:', data);
        communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id_commune;
          opt.textContent = c.nom_commune;
          communeSelect.appendChild(opt);
        });
      })
      .catch(err => {
        alert('Erreur JS communes');
        console.error('Error loading communes:', err);
      });
  }

  function updateInspectionPatrimoines() {
    const communeId = document.getElementById('id_commune').value;
    const patrimoineSelect = document.getElementById('id_patrimoine');

    if (!communeId) {
      patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }

    fetch(`/api/patrimoines-by-commune/${communeId}/`)
      .then(r => {
        if (!r.ok) {
          alert('Erreur AJAX: patrimoines');
          console.error('AJAX error patrimoines:', r.status, r.statusText);
        }
        return r.json();
      })
      .then(data => {
        console.log('Patrimoines response:', data);
        patrimoineSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_patrimoine;
          opt.textContent = p.nom_fr;
          patrimoineSelect.appendChild(opt);
        });
      })
      .catch(err => {
        alert('Erreur JS patrimoines');
        console.error('Error loading patrimoines:', err);
      });
  }

  // Auto-populate provinces if region is pre-selected (e.g. after form error)
  document.addEventListener('DOMContentLoaded', function() {
    var regionSelect = document.getElementById('id_region');
    if (regionSelect && regionSelect.value) {
      updateInspectionProvinces();
    }
  });
</script>
{% endblock %}