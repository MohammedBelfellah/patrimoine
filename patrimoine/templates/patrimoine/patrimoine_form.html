{% extends "core/base.html" %}
{% block title %}{% if patrimoine %}√âditer{% else %}Ajouter{% endif %} patrimoine{% endblock %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  #map { height: 500px; margin: 16px 0; border-radius: 8px; }
  form { display: flex; flex-direction: column; gap: 16px; }
  .form-group { display: flex; flex-direction: column; }
  label { font-weight: bold; margin-bottom: 4px; }
  input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
  textarea { min-height: 100px; }
  .form-row { display: flex; gap: 16px; }
  .form-row > .form-group { flex: 1; }
  button { padding: 10px 16px; background: #1d4ed8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
  button:hover { background: #1e40af; }
  .error { color: #dc2626; padding: 12px; background: #fee2e2; border-radius: 4px; margin-bottom: 16px; }
  .info { color: #0369a1; padding: 12px; background: #e0f2fe; border-radius: 4px; margin-bottom: 16px; }
</style>
{% endblock %}
{% block content %}
<div class="card">
  <h2>{% if patrimoine %}√âditer: {{ patrimoine.nom_fr }}{% else %}Ajouter un nouveau patrimoine{% endif %}</h2>

  <div class="info">‚ÑπÔ∏è Dessinez ou importez le polygone du patrimoine sur la carte ci-dessous.</div>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-row">
      <div class="form-group">
        <label for="nom_fr">Nom (Fran√ßais) *</label>
        <input type="text" id="nom_fr" name="nom_fr" value="{{ patrimoine.nom_fr }}" required />
      </div>
      <div class="form-group">
        <label for="nom_ar">Nom (Arabe)</label>
        <input type="text" id="nom_ar" name="nom_ar" value="{{ patrimoine.nom_ar }}" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="type_patrimoine">Type *</label>
        <select id="type_patrimoine" name="type_patrimoine" required>
          <option value="">-- S√©lectionner --</option>
          {% for code, label in patrimoine_types %}
          <option value="{{ code }}" {% if patrimoine.type_patrimoine == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="statut">Statut</label>
        <select id="statut" name="statut">
          {% for code, label in patrimoine_statuts %}
          <option value="{{ code }}" {% if patrimoine.statut == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="reference_administrative">R√©f√©rence administrative</label>
      <input type="text" id="reference_administrative" name="reference_administrative" value="{{ patrimoine.reference_administrative }}" />
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description">{{ patrimoine.description }}</textarea>
    </div>

    <div class="form-group">
      <label for="images">üì∑ Images (max 5 images, 5MB chacune)</label>
      {% if patrimoine and current_images %}
      <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <strong style="color: #666;">Images actuelles ({{ current_images|length }}/5):</strong>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 8px;">
          {% for image in current_images %}
          <div style="border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; position: relative;">
            <img src="/media/{{ image.file_path }}" alt="{{ image.file_name }}" style="width: 100%; height: 100px; object-fit: cover;">
            <div style="padding: 4px; background: white; font-size: 10px; color: #666; text-align: center;">{{ image.file_name|truncatechars:15 }}</div>
          </div>
          {% endfor %}
        </div>
        <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;"><small>Pour supprimer une image, utilisez le bouton sur la page de d√©tails.</small></p>
      </div>
      {% endif %}
      <input type="file" id="images" name="images" accept="image/jpeg,image/png,image/gif,image/webp" multiple />
      <p class="muted" style="margin-top: 4px;"><small>Formats accept√©s: JPG, PNG, GIF, WEBP. Maximum 5 images au total.</small></p>
      <div id="image-preview" style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;"></div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="region">R√©gion *</label>
        <select id="region" name="region" required onchange="updateProvinces()">
          <option value="">-- S√©lectionner --</option>
          {% for region in regions %}
          <option value="{{ region.id_region }}" {% if patrimoine.id_commune.id_province.id_region.id_region == region.id_region %}selected{% endif %}>{{ region.nom_region }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="province">Province/Pr√©fecture *</label>
        <select id="province" name="province" required onchange="updateCommunes()">
          <option value="">-- S√©lectionner --</option>
          {% for province in provinces %}
          <option value="{{ province.id_province }}" {% if patrimoine.id_commune.id_province.id_province == province.id_province %}selected{% endif %}>{{ province.nom_province }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="id_commune">Commune *</label>
      <select id="id_commune" name="id_commune" required>
        <option value="">-- S√©lectionner --</option>
        {% for commune in communes %}
        <option value="{{ commune.id_commune }}" {% if patrimoine.id_commune.id_commune == commune.id_commune %}selected{% endif %}>{{ commune.nom_commune }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Polygone g√©ographique (WGS84) *</label>
      <div class="form-group" style="margin-bottom: 12px;">
        <label for="spatial_file">Importer un fichier (KML ou Shapefile .zip)</label>
        <input type="file" id="spatial_file" name="spatial_file" accept=".kml,.zip" />
        <p class="muted"><small>Si vous importez un fichier, il remplacera le polygone dessin√©.</small></p>
      </div>
      <div id="map"></div>
      <input type="hidden" id="geojson" name="geojson" value="" />
      <p class="muted"><small>Utilisez les outils de dessin pour cr√©er le polygone, ou importez un fichier valide.</small></p>
    </div>

    <div>
      <button type="submit">{% if patrimoine %}Mettre √† jour{% else %}Cr√©er{% endif %}</button>
      <a href="{% url 'patrimoine-list' %}" class="btn btn-secondary" style="padding: 10px 16px; text-decoration: none; background: #6b7280; display: inline-block;">Annuler</a>
    </div>
  </form>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>
<script>
  const map = L.map('map').setView([31.7917, -7.0926], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon: true, polyline: false, rectangle: true, circle: false, marker: false }
  });
  map.addControl(drawControl);

  map.on('draw:created', function(e) {
    const layer = e.layer;
    if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      
      // Convert to MultiPolygon format
      const geom = layer.toGeoJSON().geometry;
      const multiPolygon = {
        type: "MultiPolygon",
        coordinates: [geom.coordinates]
      };
      document.getElementById('geojson').value = JSON.stringify(multiPolygon);
    }
  });

  map.on('draw:edited', function(e) {
    const layers = e.layers;
    layers.eachLayer(function(layer) {
      if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
        // Convert to MultiPolygon format
        const geom = layer.toGeoJSON().geometry;
        const multiPolygon = {
          type: "MultiPolygon",
          coordinates: [geom.coordinates]
        };
        document.getElementById('geojson').value = JSON.stringify(multiPolygon);
      }
    });
  });

  function updateProvinces() {
    const regionId = document.getElementById('region').value;
    const provinceSelect = document.getElementById('province');
    const communeSelect = document.getElementById('id_commune');
    
    // Reset commune select
    communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    
    if (!regionId) {
      provinceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }
    
    fetch(`/api/provinces/${regionId}/`)
      .then(r => r.json())
      .then(data => {
        provinceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_province;
          opt.textContent = p.nom_province;
          provinceSelect.appendChild(opt);
        });
      })
      .catch(err => console.error('Error loading provinces:', err));
  }

  function updateCommunes() {
    const provinceId = document.getElementById('province').value;
    const communeSelect = document.getElementById('id_commune');
    
    if (!provinceId) {
      communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      return;
    }
    
    fetch(`/api/communes/${provinceId}/`)
      .then(r => r.json())
      .then(data => {
        communeSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id_commune;
          opt.textContent = c.nom_commune;
          communeSelect.appendChild(opt);
        });
      })
      .catch(err => console.error('Error loading communes:', err));
  }

  function geometryToMultiPolygon(geometry) {
    if (!geometry) return null;
    if (geometry.type === 'Polygon') {
      return { type: 'MultiPolygon', coordinates: [geometry.coordinates] };
    }
    if (geometry.type === 'MultiPolygon') {
      return geometry;
    }
    if (geometry.type === 'GeometryCollection') {
      const polygonGeom = geometry.geometries.find(g => g.type === 'Polygon' || g.type === 'MultiPolygon');
      return geometryToMultiPolygon(polygonGeom);
    }
    return null;
  }

  document.getElementById('spatial_file').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.kml')) {
      return;
    }

    const reader = new FileReader();
    reader.onload = function (event) {
      try {
        const xml = new DOMParser().parseFromString(event.target.result, 'text/xml');
        const geo = toGeoJSON.kml(xml);
        if (!geo.features || !geo.features.length) {
          alert('Aucune g√©om√©trie trouv√©e dans le fichier KML');
          return;
        }

        const featureWithPolygon = geo.features.find(f => {
          const g = f.geometry;
          return g && ['Polygon', 'MultiPolygon', 'GeometryCollection'].includes(g.type);
        });

        if (!featureWithPolygon) {
          alert('Le KML doit contenir un polygone');
          return;
        }

        const multiPolygon = geometryToMultiPolygon(featureWithPolygon.geometry);
        if (!multiPolygon) {
          alert('Impossible de convertir la g√©om√©trie KML en polygone');
          return;
        }

        drawnItems.clearLayers();
        const layer = L.geoJSON(multiPolygon).getLayers()[0];
        drawnItems.addLayer(layer);
        map.fitBounds(layer.getBounds());
        document.getElementById('geojson').value = JSON.stringify(multiPolygon);
      } catch (err) {
        alert('Erreur de lecture du fichier KML');
      }
    };
    reader.readAsText(file);
  });

  {% if patrimoine.polygon_geom %}
  const geomJson = {{ patrimoine_geojson|safe }};
  const layer = L.geoJSON(geomJson).getLayers()[0];
  drawnItems.addLayer(layer);
  map.fitBounds(layer.getBounds());
  document.getElementById('geojson').value = JSON.stringify(geomJson);
  {% endif %}

  // Image upload preview
  document.getElementById('images').addEventListener('change', function(e) {
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    const files = Array.from(e.target.files);
    
    if (files.length > 5) {
      alert('‚ö†Ô∏è Maximum 5 images autoris√©es');
      e.target.value = '';
      return;
    }
    
    files.forEach((file, index) => {
      if (file.size > 5 * 1024 * 1024) {
        alert(`‚ö†Ô∏è "${file.name}" d√©passe 5MB`);
        e.target.value = '';
        preview.innerHTML = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = document.createElement('img');
        img.src = event.target.result;
        img.style.width = '100px';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        img.style.border = '2px solid #e5e7eb';
        img.title = file.name;
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });
</script>
{% endblock %}
