{% extends "core/base.html" %}
{% block title %}{% if patrimoine %}Éditer{% else %}Ajouter{% endif %} patrimoine{% endblock %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  #map { height: 500px; margin: 16px 0; border-radius: 8px; }
  form { display: flex; flex-direction: column; gap: 16px; }
  .form-group { display: flex; flex-direction: column; }
  label { font-weight: bold; margin-bottom: 4px; }
  input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
  textarea { min-height: 100px; }
  .form-row { display: flex; gap: 16px; }
  .form-row > .form-group { flex: 1; }
  button { padding: 10px 16px; background: #1d4ed8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
  button:hover { background: #1e40af; }
  .error { color: #dc2626; padding: 12px; background: #fee2e2; border-radius: 4px; margin-bottom: 16px; }
  .info { color: #0369a1; padding: 12px; background: #e0f2fe; border-radius: 4px; margin-bottom: 16px; }
</style>
{% endblock %}
{% block content %}
<div class="card">
  <h2>{% if patrimoine %}Éditer: {{ patrimoine.nom_fr }}{% else %}Ajouter un nouveau patrimoine{% endif %}</h2>

  {% if error %}
  <div class="error">❌ {{ error }}</div>
  {% endif %}

  <div class="info">ℹ️ Dessinez ou importez le polygone du patrimoine sur la carte ci-dessous.</div>

  <form method="post">
    {% csrf_token %}

    <div class="form-row">
      <div class="form-group">
        <label for="nom_fr">Nom (Français) *</label>
        <input type="text" id="nom_fr" name="nom_fr" value="{{ patrimoine.nom_fr }}" required />
      </div>
      <div class="form-group">
        <label for="nom_ar">Nom (Arabe)</label>
        <input type="text" id="nom_ar" name="nom_ar" value="{{ patrimoine.nom_ar }}" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="type_patrimoine">Type *</label>
        <select id="type_patrimoine" name="type_patrimoine" required>
          <option value="">-- Sélectionner --</option>
          {% for code, label in patrimoine_types %}
          <option value="{{ code }}" {% if patrimoine.type_patrimoine == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="statut">Statut</label>
        <select id="statut" name="statut">
          {% for code, label in patrimoine_statuts %}
          <option value="{{ code }}" {% if patrimoine.statut == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="reference_administrative">Référence administrative</label>
      <input type="text" id="reference_administrative" name="reference_administrative" value="{{ patrimoine.reference_administrative }}" />
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description">{{ patrimoine.description }}</textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="region">Région *</label>
        <select id="region" name="region" required onchange="updateProvinces()">
          <option value="">-- Sélectionner --</option>
          {% for region in regions %}
          <option value="{{ region.id_region }}" {% if patrimoine.id_commune.id_province.id_region.id_region == region.id_region %}selected{% endif %}>{{ region.nom_region }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="province">Province/Préfecture *</label>
        <select id="province" name="province" required onchange="updateCommunes()">
          <option value="">-- Sélectionner --</option>
          {% for province in provinces %}
          <option value="{{ province.id_province }}" {% if patrimoine.id_commune.id_province.id_province == province.id_province %}selected{% endif %}>{{ province.nom_province }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="id_commune">Commune *</label>
      <select id="id_commune" name="id_commune" required>
        <option value="">-- Sélectionner --</option>
        {% for commune in communes %}
        <option value="{{ commune.id_commune }}" {% if patrimoine.id_commune.id_commune == commune.id_commune %}selected{% endif %}>{{ commune.nom_commune }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Polygone géographique (WGS84) *</label>
      <div id="map"></div>
      <input type="hidden" id="geojson" name="geojson" value="" required />
      <p class="muted"><small>Utilisez les outils de dessin pour créer le polygone, ou collez un GeoJSON valide.</small></p>
    </div>

    <div>
      <button type="submit">{% if patrimoine %}Mettre à jour{% else %}Créer{% endif %}</button>
      <a href="{% url 'patrimoine-list' %}" class="btn btn-secondary" style="padding: 10px 16px; text-decoration: none; background: #6b7280; display: inline-block;">Annuler</a>
    </div>
  </form>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
  const map = L.map('map').setView([31.7917, -7.0926], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon: true, polyline: false, rectangle: true, circle: false, marker: false }
  });
  map.addControl(drawControl);

  map.on('draw:created', function(e) {
    const layer = e.layer;
    if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      
      // Convert to MultiPolygon format
      const geom = layer.toGeoJSON().geometry;
      const multiPolygon = {
        type: "MultiPolygon",
        coordinates: [geom.coordinates]
      };
      document.getElementById('geojson').value = JSON.stringify(multiPolygon);
    }
  });

  map.on('draw:edited', function(e) {
    const layers = e.layers;
    layers.eachLayer(function(layer) {
      if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
        // Convert to MultiPolygon format
        const geom = layer.toGeoJSON().geometry;
        const multiPolygon = {
          type: "MultiPolygon",
          coordinates: [geom.coordinates]
        };
        document.getElementById('geojson').value = JSON.stringify(multiPolygon);
      }
    });
  });

  function updateProvinces() {
    const regionId = document.getElementById('region').value;
    const provinceSelect = document.getElementById('province');
    const communeSelect = document.getElementById('id_commune');
    
    // Reset commune select
    communeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    
    if (!regionId) {
      provinceSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
      return;
    }
    
    fetch(`/api/provinces/${regionId}/`)
      .then(r => r.json())
      .then(data => {
        provinceSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_province;
          opt.textContent = p.nom_province;
          provinceSelect.appendChild(opt);
        });
      })
      .catch(err => console.error('Error loading provinces:', err));
  }

  function updateCommunes() {
    const provinceId = document.getElementById('province').value;
    const communeSelect = document.getElementById('id_commune');
    
    if (!provinceId) {
      communeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
      return;
    }
    
    fetch(`/api/communes/${provinceId}/`)
      .then(r => r.json())
      .then(data => {
        communeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
        data.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id_commune;
          opt.textContent = c.nom_commune;
          communeSelect.appendChild(opt);
        });
      })
      .catch(err => console.error('Error loading communes:', err));
  }

  {% if patrimoine.polygon_geom %}
  const geomJson = {{ patrimoine_geojson|safe }};
  const layer = L.geoJSON(geomJson).getLayers()[0];
  drawnItems.addLayer(layer);
  map.fitBounds(layer.getBounds());
  {% endif %}
</script>
{% endblock %}
