{% extends "core/base.html" %}
{% block title %}Patrimoines{% endblock %}
{% block head_extra %}
<style>
  .filter-section { margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; }
  .filter-section input, .filter-section select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
  th { background: #f0f0f0; font-weight: bold; }
  tr:hover { background: #f9f9f9; }
  .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
  .badge-mondial { background: #fff3cd; color: #333; }
  .badge-naturel { background: #d1e7dd; color: #333; }
  .badge-historique { background: #cfe2ff; color: #333; }
  .badge-autre { background: #e2e3e5; color: #333; }
  .actions { white-space: nowrap; }
  .btn { display: inline-block; padding: 6px 12px; margin: 0 4px; text-decoration: none; border-radius: 4px; }
  .btn-primary { background: #1d4ed8; color: white; }
  .btn-secondary { background: #6b7280; color: white; }
  .btn-danger { background: #dc2626; color: white; }
</style>
{% endblock %}
{% block content %}
<div class="card">
  <h2>Gestion des Patrimoines</h2>

  {% if can_edit %}
  <div style="margin-bottom: 16px;">
    <a href="{% url 'patrimoine-create' %}" class="btn btn-primary">+ Ajouter un patrimoine</a>
    <a href="{% url 'patrimoine-map' %}" class="btn btn-secondary">Voir la carte</a>
  </div>
  {% endif %}

  <div class="filter-section">
    <form method="get" style="display: flex; gap: 12px; flex-wrap: wrap;">
      <input type="text" name="search" placeholder="Rechercher par nom..." value="{{ request.GET.search }}" />
      <select name="type">
        <option value="">-- Tous les types --</option>
        {% for code, label in patrimoine_types %}
        <option value="{{ code }}" {% if request.GET.type == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <select name="statut">
        <option value="">-- Tous les statuts --</option>
        {% for code, label in patrimoine_statuts %}
        <option value="{{ code }}" {% if request.GET.statut == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <select name="region">
        <option value="">-- Toutes les régions --</option>
        {% for region in regions %}
        <option value="{{ region.id_region }}" {% if request.GET.region == region.id_region|stringformat:"s" %}selected{% endif %}>{{ region.nom_region }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-primary">Filtrer</button>
    </form>
  </div>

  {% if patrimoines %}
  <table>
    <thead>
      <tr>
        <th>Nom</th>
        <th>Type</th>
        <th>Statut</th>
        <th>Localisation</th>
        <th>Créé par</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in patrimoines %}
      <tr>
        <td><strong>{{ p.nom_fr }}</strong></td>
        <td>
          <span class="badge badge-{{ p.type_patrimoine|lower }}">
            {{ p.get_type_patrimoine_display }}
          </span>
        </td>
        <td>{{ p.get_statut_display }}</td>
        <td><small>{{ p.full_location }}</small></td>
        <td>{{ p.created_by.email }}</td>
        <td class="actions">
          <a href="{% url 'patrimoine-detail' p.id_patrimoine %}" class="btn btn-secondary">Voir</a>
          {% if can_edit %}
          <a href="{% url 'patrimoine-edit' p.id_patrimoine %}" class="btn btn-primary">Éditer</a>
          {% if user.is_superuser %}
          <form method="post" action="{% url 'patrimoine-delete' p.id_patrimoine %}" style="display:inline;" onsubmit="return confirm('Confirmer suppression?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Supprimer</button>
          </form>
          {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="muted">Aucun patrimoine trouvé.</p>
  {% endif %}
</div>
{% endblock %}
